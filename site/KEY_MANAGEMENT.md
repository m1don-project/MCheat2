# Управление ключами лицензий

## Создание ключей

### Способ 1: Через веб-панель (рекомендуется)

1. Войдите в панель: `http://ваш-сервер/login.html`
2. Перейдите на страницу **"Ключи"**
3. Заполните форму создания ключа:

   **Параметры:**
   - **Срок действия (дни)**: Количество дней до истечения (например, `30` = 30 дней)
   - **Или дата истечения**: Конкретная дата в формате `YYYY-MM-DD HH:MM:SS`
   - **HWID**: Оставьте пустым (привяжется при первой активации) или укажите заранее
   - **Комментарий**: Любая заметка для себя

4. Нажмите **"Создать ключ"**
5. Скопируйте созданный ключ (например, `DEMO-KEY-XXXX-XXXX-XXXX`)

### Способ 2: Через API (программно)

#### Авторизация

```bash
# Получите токен доступа
curl -X POST http://ваш-сервер/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"ваш_пароль"}'

# Ответ:
# {
#   "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "refreshToken": "...",
#   "user": {...}
# }
```

#### Создание ключа на 30 дней

```bash
curl -X POST http://ваш-сервер/api/keys \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "valid_days": 30,
    "comment": "Ключ для клиента Иванов"
  }'
```

#### Создание ключа с конкретной датой истечения

```bash
curl -X POST http://ваш-сервер/api/keys \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "expires_at": "2025-12-31 23:59:59",
    "hwid": "PC-USER-001",
    "comment": "Премиум ключ до конца года"
  }'
```

#### Создание бессрочного ключа

```bash
curl -X POST http://ваш-сервер/api/keys \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "comment": "Бессрочная лицензия"
  }'
```

**Ответ:**
```json
{
  "id": 1,
  "key_value": "DEMO-KEY-XXXX-XXXX-XXXX",
  "status": "pending",
  "expires_at": "2025-12-31T23:59:59.000Z",
  "hwid": null,
  "is_blocked": false,
  "comment": "Премиум ключ до конца года",
  "created_at": "2025-12-02T12:00:00.000Z"
}
```

---

## Настройка времени действия

### Варианты указания срока:

1. **Через количество дней** (`valid_days`):
   - `7` = неделя
   - `30` = месяц
   - `90` = квартал
   - `365` = год

2. **Через конкретную дату** (`expires_at`):
   - Формат: `YYYY-MM-DD HH:MM:SS` (например, `2025-12-31 23:59:59`)
   - Или ISO: `2025-12-31T23:59:59.000Z`

3. **Бессрочный ключ**:
   - Не указывайте ни `valid_days`, ни `expires_at`
   - Ключ будет работать до ручной блокировки

### Примеры времени действия:

| Сценарий | Параметры |
|----------|-----------|
| Пробный период (7 дней) | `{"valid_days": 7}` |
| Месячная подписка | `{"valid_days": 30}` |
| Годовая лицензия | `{"valid_days": 365}` |
| До конкретной даты | `{"expires_at": "2025-12-31 23:59:59"}` |
| Бессрочный | `{}` (без параметров времени) |

---

## Управление ключами через панель

### Просмотр всех ключей

1. Откройте страницу **"Ключи"**
2. Используйте поиск и фильтры:
   - Поиск по ключу
   - Фильтр по статусу (pending, active, expired)

### Блокировка/разблокировка

1. Найдите нужный ключ в таблице
2. Нажмите кнопку **"Блок"** или **"Разблок"**
3. Заблокированный ключ не может быть активирован клиентами

### Изменение HWID

1. Найдите ключ
2. Нажмите **"HWID"**
3. Введите новый HWID или оставьте пустым для сброса
4. Ключ можно будет активировать на новом устройстве

### Продление срока

1. Найдите ключ
2. Нажмите **"Продлить"**
3. Укажите количество дней для продления (например, `+30` дней)
4. Или укажите новую дату истечения

### Просмотр истории активаций

1. Найдите ключ
2. Нажмите **"История"**
3. Откроется таблица с записями:
   - Дата и время
   - HWID
   - Действие (activate, check, etc.)
   - Метаданные (IP, User-Agent, комментарий)

---

## Управление через API

### Получить список всех ключей

```bash
curl -X GET http://ваш-сервер/api/keys \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN"
```

### Поиск ключа

```bash
curl -X GET "http://ваш-сервер/api/keys?search=DEMO-KEY" \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN"
```

### Фильтр по статусу

```bash
curl -X GET "http://ваш-сервер/api/keys?status=active" \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN"
```

### Получить информацию о конкретном ключе

```bash
curl -X GET http://ваш-сервер/api/keys/1 \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN"
```

### Блокировка ключа

```bash
curl -X PUT http://ваш-сервер/api/keys/1/block \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_blocked": true}'
```

### Изменение HWID

```bash
curl -X PUT http://ваш-сервер/api/keys/1/hwid \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"hwid": "NEW-HWID-123"}'
```

### Продление срока

```bash
# Продлить на 30 дней
curl -X PUT http://ваш-сервер/api/keys/1/extend \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"days": 30}'

# Или установить новую дату
curl -X PUT http://ваш-сервер/api/keys/1/extend \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"expires_at": "2026-01-01 00:00:00"}'
```

### Получить историю активаций

```bash
curl -X GET http://ваш-сервер/api/keys/1/history \
  -H "Authorization: Bearer ВАШ_ACCESS_TOKEN"
```

---

## Клиентское API (для вашего EXE)

### Активация ключа

```cpp
// Пример на C++ (используя WebApi.h)
std::string key = "DEMO-KEY-XXXX-XXXX-XXXX";
std::string hwid = GetHWID(); // Ваша функция получения HWID

std::string jsonBody = R"({"key":")" + key + R"(","hwid":")" + hwid + R"("})";
std::string response;

try {
    Web::Post("http://ваш-сервер/api/activate_key", jsonBody, response);
    // response содержит: {"message":"Активация успешна","expires_at":"...","hwid":"..."}
} catch (const std::exception& e) {
    // Обработка ошибки (ключ не найден, заблокирован, истёк и т.д.)
}
```

### Проверка ключа

```cpp
std::string jsonBody = R"({"key":")" + key + R"(","hwid":")" + hwid + R"("})";
std::string response;
Web::Post("http://ваш-сервер/api/check_key", jsonBody, response);

// response содержит:
// {
//   "key": "DEMO-KEY-...",
//   "status": "active",
//   "hwid": "PC-001",
//   "expires_at": "2025-12-31T23:59:59.000Z",
//   "is_blocked": false,
//   "hwid_matches": true,
//   "remaining_days": 30
// }
```

### Получение остатка дней

```cpp
std::string url = "http://ваш-сервер/api/get_remaining_days?key=" + key;
std::string response;
Web::Get(url, response);

// response: {"remaining_days": 30}
// или {"remaining_days": null} для бессрочного ключа
```

---

## Типичные сценарии

### Сценарий 1: Пробный период

1. Создайте ключ на 7 дней: `{"valid_days": 7}`
2. Отдайте ключ клиенту
3. Клиент активирует ключ при первом запуске
4. Через 7 дней ключ автоматически станет недействительным

### Сценарий 2: Месячная подписка

1. Создайте ключ на 30 дней: `{"valid_days": 30}`
2. Клиент активирует
3. При продлении используйте кнопку **"Продлить"** (+30 дней)

### Сценарий 3: Бессрочная лицензия

1. Создайте ключ без указания срока: `{}`
2. Ключ будет работать до ручной блокировки
3. Можно привязать к конкретному HWID для защиты

### Сценарий 4: Ключ с привязкой к устройству

1. Создайте ключ: `{"valid_days": 365, "hwid": "PC-USER-001"}`
2. Ключ будет работать только на указанном устройстве
3. Для смены устройства используйте кнопку **"HWID"** в панели

---

## Часто задаваемые вопросы

**Q: Как создать ключ на несколько лет?**  
A: Используйте `valid_days: 1095` (3 года) или укажите конкретную дату через `expires_at`.

**Q: Можно ли изменить срок уже созданного ключа?**  
A: Да, используйте функцию **"Продлить"** в панели или API endpoint `/api/keys/:id/extend`.

**Q: Что происходит, когда срок истекает?**  
A: Ключ автоматически получает статус `expired` и не может быть активирован. Клиент получит ошибку при попытке активации.

**Q: Можно ли восстановить истёкший ключ?**  
A: Да, продлите его через панель или API, указав новую дату или количество дней.

**Q: Как ограничить ключ одним устройством?**  
A: При первой активации ключ автоматически привязывается к HWID. Для предварительной привязки укажите `hwid` при создании.

**Q: Что делать, если клиент сменил компьютер?**  
A: В панели найдите ключ, нажмите **"HWID"**, очистите поле (или введите новый HWID), сохраните. Клиент сможет активировать ключ на новом устройстве.

